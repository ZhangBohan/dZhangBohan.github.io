<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>数据库版本管理工具Liquibase | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="研发过程中经常涉及到数据库变更，对表结构的修复及对数据的修改，为了保证各环境都能正确的进行变更我们可能需要维护一个数据库升级文档来保存这些记录，有需要升级的环境按文档进行升级。 这样手工维护有几个缺点：  无法保证每个环境都按要求执行 遇到问题不一定有相对的回滚语句 无法自动化  为了解决这些问题，我们进行了一些调研，主要调研对象是Liquibase和Flyway，我们希望通过数据库版本管理工具">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库版本管理工具Liquibase">
<meta property="og:url" content="http://example.com/2019/12/24/title-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Liquibase/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="研发过程中经常涉及到数据库变更，对表结构的修复及对数据的修改，为了保证各环境都能正确的进行变更我们可能需要维护一个数据库升级文档来保存这些记录，有需要升级的环境按文档进行升级。 这样手工维护有几个缺点：  无法保证每个环境都按要求执行 遇到问题不一定有相对的回滚语句 无法自动化  为了解决这些问题，我们进行了一些调研，主要调研对象是Liquibase和Flyway，我们希望通过数据库版本管理工具">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://image.1programmer.com/2019-12-24-15772015720671.jpg">
<meta property="article:published_time" content="2019-12-24T15:34:26.000Z">
<meta property="article:modified_time" content="2022-05-16T06:56:46.848Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="database, migrate, java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.1programmer.com/2019-12-24-15772015720671.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-title-数据库版本管理工具Liquibase" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/24/title-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Liquibase/" class="article-date">
  <time class="dt-published" datetime="2019-12-24T15:34:26.000Z" itemprop="datePublished">2019-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      数据库版本管理工具Liquibase
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://image.1programmer.com/2019-12-24-15772015720671.jpg"></p>
<p>研发过程中经常涉及到数据库变更，对表结构的修复及对数据的修改，为了保证各环境都能正确的进行变更我们可能需要维护一个数据库升级文档来保存这些记录，有需要升级的环境按文档进行升级。</p>
<p>这样手工维护有几个缺点：</p>
<ol>
<li>无法保证每个环境都按要求执行</li>
<li>遇到问题不一定有相对的回滚语句</li>
<li>无法自动化</li>
</ol>
<p>为了解决这些问题，我们进行了一些调研，主要调研对象是Liquibase和Flyway，我们希望通过数据库版本管理工具实现以下几个目标：</p>
<ol>
<li>数据库升级</li>
<li>数据库回滚</li>
<li>版本标记</li>
</ol>
<p>调研过程中发现Flyway据库回滚功能是增值功能且实现逻辑是通过我们的升级脚本来进行“智能”降级，不符合我们目前的使用场景，Flyway相关的介绍可以看我早期的另一篇介绍：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000000422670">https://segmentfault.com/a/1190000000422670</a></p>
<h2 id="Liquibase"><a href="#Liquibase" class="headerlink" title="Liquibase"></a>Liquibase</h2><blockquote>
<p>Liquibase帮助团队跟踪、版本化及部署数据库架构和逻辑修改</p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="检查JRE"><a href="#检查JRE" class="headerlink" title="检查JRE"></a>检查JRE</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ java -version</span><br><span class="line">java version &quot;1.8.0_231&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_231-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.231-b11, mixed mode)</span><br></pre></td></tr></table></figure>
<p>如果没有安装Java请自行安装</p>
<h4 id="安装Liquibase"><a href="#安装Liquibase" class="headerlink" title="安装Liquibase"></a>安装Liquibase</h4><p>下载<a target="_blank" rel="noopener" href="https://download.liquibase.org/download/">Liquibase-Version#-bin.tar.gz 文件</a>，<br>解压压缩包，将目录添加到环境变量中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export PATH=&quot;/opt/liquibase-3.8.2:$PATH&quot;</span><br></pre></td></tr></table></figure>

<p>这个命令重新启动命令行就不会生效了，如果要保证一直可用需要将这个领先设置到<code>.bashrc</code>或者<code>.zshrc</code>中</p>
<p>通过运行帮助命令验证安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ liquibase --help</span><br><span class="line">17:12:10.389 [main] DEBUG liquibase.resource.ClassLoaderResourceAccessor - Opening jar:file:/opt/liquibase-3.8.2/liquibase.jar!/liquibase.build.properties as liquibase.build.properties</span><br><span class="line">Starting Liquibase at 星期三, 04 十二月 2019 17:12:10 CST (version 3.8.2 #26 built at Tue Nov 26 04:53:39 UTC 2019)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage: java -jar liquibase.jar [options] [command]</span><br><span class="line"></span><br><span class="line">Standard Commands:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>下面是以mysql为例的配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cat liquibase.properties</span><br><span class="line">driver: com.mysql.cj.jdbc.Driver</span><br><span class="line">classpath: ./mysql-connector-java-8.0.18.jar</span><br><span class="line">url: jdbc:mysql://127.0.0.1/test</span><br><span class="line">username: root</span><br><span class="line">password: 123456</span><br><span class="line">changeLogFile: myChangeLog.xml</span><br></pre></td></tr></table></figure>

<h3 id="数据库升级"><a href="#数据库升级" class="headerlink" title="数据库升级"></a>数据库升级</h3><p>创建<code>myChangeLog.xml</code>文件，这个文件用来记录升级记录升级信息，初始化的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat myChangeLog.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;databaseChangeLog</span><br><span class="line">  xmlns=&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span><br><span class="line">  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://www.liquibase.org/xml/ns/dbchangelog</span><br><span class="line">         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;/databaseChangeLog&gt;</span><br></pre></td></tr></table></figure>

<p>Liquibase支持通过SQL描述的方式来创建数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ cat myChangeLog.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;databaseChangeLog</span><br><span class="line">  xmlns=&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span><br><span class="line">  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://www.liquibase.org/xml/ns/dbchangelog</span><br><span class="line">         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;changeSet id=&quot;1.0&quot; author=&quot;bohan&quot;&gt;</span><br><span class="line">        &lt;sql&gt;</span><br><span class="line">        CREATE TABLE `deparment` (</span><br><span class="line">        `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">        `name` varchar(100) COLLATE utf8mb4_bin DEFAULT NULL,</span><br><span class="line">        PRIMARY KEY (`id`)</span><br><span class="line">        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;</span><br><span class="line">        &lt;/sql&gt;</span><br><span class="line">    &lt;/changeSet&gt;</span><br><span class="line">&lt;/databaseChangeLog&gt;</span><br><span class="line">$ liquibase update</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Liquibase: Update has been successful.</span><br></pre></td></tr></table></figure>

<p>通过执行<code>liquibase update</code>进行升级，升级后的数据库如下，已经为我们创建了数据库，同时Liquibase生成了两个表用来管理数据库升级记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -h 127.0.0.1 -uroot -p123456 test -e &quot;show tables;&quot;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+-----------------------+</span><br><span class="line">| Tables_in_test        |</span><br><span class="line">+-----------------------+</span><br><span class="line">| DATABASECHANGELOG     |</span><br><span class="line">| DATABASECHANGELOGLOCK |</span><br><span class="line">| deparment             |</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>

<p>继续执行升级</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ cat myChangeLog.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;databaseChangeLog</span><br><span class="line">  xmlns=&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span><br><span class="line">  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://www.liquibase.org/xml/ns/dbchangelog</span><br><span class="line">         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;changeSet id=&quot;1.0&quot; author=&quot;bohan&quot;&gt;</span><br><span class="line">        &lt;sql&gt;</span><br><span class="line">        CREATE TABLE `deparment` (</span><br><span class="line">        `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">        `name` varchar(100) COLLATE utf8mb4_bin DEFAULT NULL,</span><br><span class="line">        PRIMARY KEY (`id`)</span><br><span class="line">        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;</span><br><span class="line">        &lt;/sql&gt;</span><br><span class="line">    &lt;/changeSet&gt;</span><br><span class="line">    &lt;changeSet id=&quot;1.1&quot; author=&quot;bohan&quot;&gt;</span><br><span class="line">        &lt;sql&gt;</span><br><span class="line">        insert into deparment values(1, &quot;test&quot;);</span><br><span class="line">        &lt;/sql&gt;</span><br><span class="line">    &lt;/changeSet&gt;</span><br><span class="line">&lt;/databaseChangeLog&gt;</span><br><span class="line">$ liquibase update</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Liquibase: Update has been successful.</span><br><span class="line">$ mysql -h 127.0.0.1 -uroot -p test -e &quot;select * from deparment;&quot;</span><br><span class="line">Enter password:</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | test |</span><br><span class="line">+----+------+</span><br></pre></td></tr></table></figure>

<p>数据如预期被添加</p>
<h4 id="通过SQL文件"><a href="#通过SQL文件" class="headerlink" title="通过SQL文件"></a>通过SQL文件</h4><p>数据库变更也可以通过sql文件形式引用，避免<code>myChangeLog.xml</code>文件过大</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;changeSet id=&quot;1.1&quot; author=&quot;bohan&quot;&gt;</span><br><span class="line">    &lt;sqlFile path=&quot;./update_deparment_name.sql&quot;&gt;&lt;/sqlFile&gt;</span><br><span class="line">&lt;/changeSet&gt;</span><br></pre></td></tr></table></figure>

<h3 id="数据库回滚"><a href="#数据库回滚" class="headerlink" title="数据库回滚"></a>数据库回滚</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">liquibase --help</span><br><span class="line">Usage: java -jar liquibase.jar [options] [command]</span><br><span class="line"></span><br><span class="line">Standard Commands:</span><br><span class="line"> rollbackCount &lt;value&gt;          Rolls back the last &lt;value&gt; change sets</span><br><span class="line">                                applied to the database</span><br></pre></td></tr></table></figure>

<p>我们来执行<code>rollbackCount</code>进行回滚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ liquibase rollbackCount 1</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Rolling Back Changeset:myChangeLog.xml::1.0::bohan</span><br><span class="line">Unexpected error running Liquibase: No inverse to liquibase.change.core.RawSQLChange created</span><br><span class="line">For more information, please use the --logLevel flag</span><br></pre></td></tr></table></figure>

<p>提示没有回滚SQL，修改我们的<code>myChangeLog.xml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ cat myChangeLog.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;databaseChangeLog</span><br><span class="line">  xmlns=&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span><br><span class="line">  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://www.liquibase.org/xml/ns/dbchangelog</span><br><span class="line">         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;changeSet id=&quot;1.0&quot; author=&quot;bohan&quot;&gt;</span><br><span class="line">        &lt;sql&gt;</span><br><span class="line">        CREATE TABLE `deparment` (</span><br><span class="line">        `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">        `name` varchar(100) COLLATE utf8mb4_bin DEFAULT NULL,</span><br><span class="line">        PRIMARY KEY (`id`)</span><br><span class="line">        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;</span><br><span class="line">        &lt;/sql&gt;</span><br><span class="line">        &lt;rollback&gt;</span><br><span class="line">        DROP TABLE deparment;</span><br><span class="line">        &lt;/rollback&gt;</span><br><span class="line">    &lt;/changeSet&gt;</span><br><span class="line">    &lt;changeSet id=&quot;1.1&quot; author=&quot;bohan&quot;&gt;</span><br><span class="line">        &lt;sql&gt;</span><br><span class="line">        insert into deparment values(1, &quot;test&quot;);</span><br><span class="line">        &lt;/sql&gt;</span><br><span class="line">        &lt;rollback&gt;</span><br><span class="line">        DELETE FROM deparment WHERE id = 1;</span><br><span class="line">        &lt;/rollback&gt;</span><br><span class="line">    &lt;/changeSet&gt;</span><br><span class="line">&lt;/databaseChangeLog&gt;</span><br></pre></td></tr></table></figure>

<p>执行回滚，发现已经没有新增的记录了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">liquibase rollbackCount 1</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Rolling Back Changeset:myChangeLog.xml::1.1::bohan</span><br><span class="line">Liquibase: Rollback has been successful.</span><br><span class="line">$ mysql -h 127.0.0.1 -uroot -p test -e &quot;select * from deparment;&quot;</span><br><span class="line">Enter password:</span><br></pre></td></tr></table></figure>

<p>再次执行，数据库也如预期被删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ liquibase rollbackCount 1</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Rolling Back Changeset:myChangeLog.xml::1.0::bohan</span><br><span class="line">Liquibase: Rollback has been successful.</span><br><span class="line">$ mysql -h 127.0.0.1 -uroot -p test -e &quot;show tables;&quot;</span><br><span class="line">Enter password:</span><br><span class="line">+-----------------------+</span><br><span class="line">| Tables_in_test        |</span><br><span class="line">+-----------------------+</span><br><span class="line">| DATABASECHANGELOG     |</span><br><span class="line">| DATABASECHANGELOGLOCK |</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>

<h3 id="版本标记"><a href="#版本标记" class="headerlink" title="版本标记"></a>版本标记</h3><p>Liquibase提供了完善的标签功能，经过刚刚的回滚到上一次操作后我们目前只执行了ID为1.0的变更</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from DATABASECHANGELOG;</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| ID  | AUTHOR | FILENAME        | DATEEXECUTED        | ORDEREXECUTED | EXECTYPE | MD5SUM                             | DESCRIPTION | COMMENTS | TAG  | LIQUIBASE | CONTEXTS | LABELS | DEPLOYMENT_ID |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| 1.0 | bohan  | myChangeLog.xml | 2019-12-05 03:15:18 |             1 | EXECUTED | 8:fe52f094e795797c89459e8f22483482 | sql         |          | NULL | 3.8.2     | NULL     | NULL   | 5515718387    |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>在实际开发中，我们升级版本时通常会需要同时执行多个变更，如果变量存在问题需要回滚时按数量回滚就比较麻烦了，我们需要对我们的变更进行标签标记，下面可能用到的命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">liquibase --help</span><br><span class="line">11:21:31.994 [main] DEBUG liquibase.resource.ClassLoaderResourceAccessor - Opening jar:file:/opt/liquibase-3.8.2/liquibase.jar!/liquibase.build.properties as liquibase.build.properties</span><br><span class="line">Starting Liquibase at 星期四, 05 十二月 2019 11:21:31 CST (version 3.8.2 #26 built at Tue Nov 26 04:53:39 UTC 2019)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage: java -jar liquibase.jar [options] [command]</span><br><span class="line"></span><br><span class="line">Standard Commands:</span><br><span class="line"> rollback &lt;tag&gt;                 Rolls back the database to the the state is was</span><br><span class="line">Maintenance Commands</span><br><span class="line"> tag &lt;tag string&gt;          &#x27;Tags&#x27; the current database state for future rollback</span><br><span class="line"> tagExists &lt;tag string&gt;    Checks whether the given tag is already existing</span><br></pre></td></tr></table></figure>

<p>针对当前数据库，我们通过<code>liquibase tag</code>进行打标签操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ liquibase tag v1.0</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Successfully tagged &#x27;root@172.17.0.1@jdbc:mysql://127.0.0.1/test&#x27;</span><br><span class="line">Liquibase command &#x27;tag&#x27; was executed successfully.</span><br></pre></td></tr></table></figure>

<p>查看记录发现ID为<code>1.0</code>的记录TAG中已设置为<code>v1.0</code>，符合我们的预期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from DATABASECHANGELOG;</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| ID  | AUTHOR | FILENAME        | DATEEXECUTED        | ORDEREXECUTED | EXECTYPE | MD5SUM                             | DESCRIPTION | COMMENTS | TAG  | LIQUIBASE | CONTEXTS | LABELS | DEPLOYMENT_ID |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| 1.0 | bohan  | myChangeLog.xml | 2019-12-05 03:15:18 |             1 | EXECUTED | 8:fe52f094e795797c89459e8f22483482 | sql         |          | v1.0 | 3.8.2     | NULL     | NULL   | 5515718387    |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>执行更新后如果需要回滚通过<code>liquibase rollback v1.0</code>即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ liquibase update</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Liquibase: Update has been successful.</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from DATABASECHANGELOG;</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| ID  | AUTHOR | FILENAME        | DATEEXECUTED        | ORDEREXECUTED | EXECTYPE | MD5SUM                             | DESCRIPTION | COMMENTS | TAG  | LIQUIBASE | CONTEXTS | LABELS | DEPLOYMENT_ID |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| 1.0 | bohan  | myChangeLog.xml | 2019-12-05 03:15:18 |             1 | EXECUTED | 8:fe52f094e795797c89459e8f22483482 | sql         |          | v1.0 | 3.8.2     | NULL     | NULL   | 5515718387    |</span><br><span class="line">| 1.1 | bohan  | myChangeLog.xml | 2019-12-05 03:28:06 |             2 | EXECUTED | 8:695a5ec0b2b3ddc4a9beeeca530adebc | sql         |          | NULL | 3.8.2     | NULL     | NULL   | 5516486105    |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ liquibase rollback v1.0</span><br><span class="line">Liquibase Community 3.8.2 by Datical</span><br><span class="line">Rolling Back Changeset:myChangeLog.xml::1.1::bohan</span><br><span class="line">Liquibase: Rollback has been successful.</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from DATABASECHANGELOG;</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| ID  | AUTHOR | FILENAME        | DATEEXECUTED        | ORDEREXECUTED | EXECTYPE | MD5SUM                             | DESCRIPTION | COMMENTS | TAG  | LIQUIBASE | CONTEXTS | LABELS | DEPLOYMENT_ID |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">| 1.0 | bohan  | myChangeLog.xml | 2019-12-05 03:15:18 |             1 | EXECUTED | 8:fe52f094e795797c89459e8f22483482 | sql         |          | v1.0 | 3.8.2     | NULL     | NULL   | 5515718387    |</span><br><span class="line">+-----+--------+-----------------+---------------------+---------------+----------+------------------------------------+-------------+----------+------+-----------+----------+--------+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/12/24/title-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Liquibase/" data-id="cl38diakt001xdb7o7fe006ca" data-title="数据库版本管理工具Liquibase" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database-migrate-java/" rel="tag">database, migrate, java</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/03/05/title-SpringBoot-actuator%E7%9B%91%E6%8E%A7%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          SpringBoot actuator监控定时任务执行时间
        
      </div>
    </a>
  
  
    <a href="/2019/11/23/title-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6Karate%E5%85%A5%E9%97%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">接口测试框架Karate入门</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coding/" rel="tag">Coding</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DB/" rel="tag">DB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DEBUG/" rel="tag">DEBUG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LOG/" rel="tag">LOG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TODO/" rel="tag">TODO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/api-test-test-bdd/" rel="tag">api-test, test, bdd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database-migrate-java/" rel="tag">database, migrate, java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html5-note/" rel="tag">html5 note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-springboot-actuator-schedule/" rel="tag">java,springboot,actuator,schedule</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unittest/" rel="tag">unittest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%82%B9%E5%AD%90/" rel="tag">点子</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BF%BB%E8%AF%91/" rel="tag">翻译</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/Coding/" style="font-size: 10px;">Coding</a> <a href="/tags/DB/" style="font-size: 10px;">DB</a> <a href="/tags/DEBUG/" style="font-size: 10px;">DEBUG</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/LOG/" style="font-size: 10px;">LOG</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 20px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Redis/" style="font-size: 20px;">Redis</a> <a href="/tags/TODO/" style="font-size: 10px;">TODO</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/api-test-test-bdd/" style="font-size: 10px;">api-test, test, bdd</a> <a href="/tags/database-migrate-java/" style="font-size: 10px;">database, migrate, java</a> <a href="/tags/html5-note/" style="font-size: 10px;">html5 note</a> <a href="/tags/java-springboot-actuator-schedule/" style="font-size: 10px;">java,springboot,actuator,schedule</a> <a href="/tags/unittest/" style="font-size: 10px;">unittest</a> <a href="/tags/%E7%82%B9%E5%AD%90/" style="font-size: 10px;">点子</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">笔记</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 10px;">翻译</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/05/16/iOS%E5%A6%82%E4%BD%95%E4%B8%8B%E8%BD%BD%E5%B9%B6%E4%BD%BF%E7%94%A8%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%EF%BC%88%E7%BF%BB%E5%A2%99%EF%BC%89/">iOS如何下载并使用科学上网（翻墙）</a>
          </li>
        
          <li>
            <a href="/2020/03/05/title-SpringBoot-actuator%E7%9B%91%E6%8E%A7%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4/">SpringBoot actuator监控定时任务执行时间</a>
          </li>
        
          <li>
            <a href="/2019/12/24/title-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7Liquibase/">数据库版本管理工具Liquibase</a>
          </li>
        
          <li>
            <a href="/2019/11/23/title-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6Karate%E5%85%A5%E9%97%A8/">接口测试框架Karate入门</a>
          </li>
        
          <li>
            <a href="/2017/08/14/HTML5%E5%86%85%E5%AE%B9%E6%8A%98%E5%8F%A0/">HTML5内容折叠</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>